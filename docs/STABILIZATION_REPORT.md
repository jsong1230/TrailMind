# TrailMind 안정화 리포트

## 1. 문제점 요약

### 1.1 서버리스 API 안정화
- ❌ JSON 파싱 실패 시 재시도 로직 없음
- ❌ 필수 필드 검증 부족 (특히 "오늘의_질문"이 비어있을 수 있음)
- ❌ 입력 길이 제한 없음 (과도한 토큰 소비 가능)
- ❌ 하루 호출 횟수 제한 없음
- ❌ 타임아웃 처리 부족 (30초 maxDuration만 설정됨)

### 1.2 프롬프트 품질
- ⚠️ 프롬프트가 너무 길고 상세함 (CTO가 읽기에는 과함)
- ❌ promptVersion이 없어 프롬프트 변경 추적 불가
- ⚠️ "오늘의_질문"이 항상 의미있게 나오도록 강조 부족

### 1.3 프론트엔드 UX
- ⚠️ 중복 클릭 방지는 있지만 로딩 상태가 명확하지 않음
- ⚠️ JSON이 비어있거나 일부만 있을 때 조건부 렌더링 개선 필요
- ⚠️ 에러 메시지가 기술적일 수 있음

### 1.4 운영 가드레일
- ❌ 하루 호출 횟수 제한 없음
- ❌ 입력 길이 제한 없음
- ❌ 제한 초과 시 친절한 안내 부족

---

## 2. 권장 수정 사항 (우선순위)

### 우선순위 1: 서버리스 API 안정화
1. JSON 파싱 실패 시 1회 재시도 로직 추가
2. 필수 필드 검증 강화 (특히 "오늘의_질문")
3. 입력 길이 제한 (3,000자)
4. 하루 호출 횟수 제한 (30회/IP)
5. 타임아웃 에러 처리 개선

### 우선순위 2: 프롬프트 품질 고정
1. promptVersion 도입 (로그에 저장)
2. 프롬프트 간결화 (CTO 관점에서 읽기 좋게)
3. "오늘의_질문" 필수성 강조
4. 상담/위로 톤 완전 제거

### 우선순위 3: 프론트엔드 UX 보정
1. 중복 클릭 방지 강화 (버튼 비활성화 + 시각적 피드백)
2. 조건부 렌더링 개선 (빈 필드 처리)
3. 에러 메시지 한글화 및 사용자 친화적 개선

### 우선순위 4: 운영 가드레일
1. LocalStorage 기반 하루 호출 횟수 추적
2. 입력 길이 검증 (프론트엔드 + 백엔드)
3. 제한 초과 시 친절한 안내 메시지

---

## 3. 코드 변경 예시

### 3.1 API 안정화 (`api/generate.ts`)

```typescript
// 주요 변경사항:
// 1. 입력 길이 제한 (3,000자)
// 2. 하루 호출 횟수 제한 (30회/IP, 간단한 메모리 기반)
// 3. JSON 파싱 재시도 (1회)
// 4. 필수 필드 검증 (특히 "오늘의_질문")
// 5. promptVersion 도입
```

### 3.2 프롬프트 개선 (`api/generate.ts` 내 GUIDE_PROMPTS)

```typescript
// 주요 변경사항:
// 1. 프롬프트 간결화
// 2. "오늘의_질문" 필수성 강조
// 3. promptVersion 추가
```

### 3.3 프론트엔드 UX (`src/components/ReflectionItem.tsx`)

```typescript
// 주요 변경사항:
// 1. 중복 클릭 방지 강화
// 2. 로딩 상태 명확화
// 3. 에러 메시지 개선
```

### 3.4 운영 가드레일 (`src/utils/api.ts`)

```typescript
// 주요 변경사항:
// 1. 입력 길이 검증
// 2. 하루 호출 횟수 추적 (LocalStorage)
```

---

## 4. 다음 단계 로드맵

### 1주차: 안정화 완료
- [x] API 안정화 (재시도, 검증, 제한)
- [x] 프롬프트 품질 고정
- [x] 프론트엔드 UX 보정
- [x] 운영 가드레일 추가

### 2주차: 다음 기능 제안
1. **검색 기능**: 날짜/키워드로 과거 반성 검색
2. **패턴 인식**: 주간/월간 반복되는 주제 자동 감지
3. **익스포트 개선**: PDF/마크다운 다중 형식 지원

---

## 5. 다음 기능 상세 제안

### 기능 1: 검색 기능 (우선순위: 높음)
- **목적**: 과거 반성을 빠르게 찾아 연결점 발견
- **구현**: 
  - LocalStorage 기반 클라이언트 사이드 검색
  - 키워드 하이라이트
  - 날짜 범위 필터
- **UI**: 
  - 상단 검색바 (전역)
  - 검색 결과 페이지 (날짜/키워드 필터)
  - 검색어 하이라이트 표시
- **예상 작업 시간**: 1주
- **철학 부합도**: ⭐⭐⭐⭐⭐ (조용한 사고 도구의 핵심)

### 기능 2: 패턴 인식 (우선순위: 중간)
- **목적**: 반복되는 주제나 감정 패턴 자동 감지
- **구현**: 
  - 주간/월간 집계 확장
  - 키워드 빈도 분석 (감정어, 관계어, 사고 패턴)
  - 시간대별 패턴 추적 (예: 월요일 vs 금요일)
- **UI**: 
  - 주간 인사이트 페이지 확장
  - 월간 패턴 차트 (간단한 텍스트 기반)
  - 반복 주제 자동 리스트
- **예상 작업 시간**: 1.5주
- **철학 부합도**: ⭐⭐⭐⭐ (자기 인식 강화)

### 기능 3: 익스포트 개선 (우선순위: 낮음)
- **목적**: 반성을 외부로 가져가기 (노션, Obsidian 등)
- **구현**: 
  - PDF 생성 (jsPDF 또는 브라우저 인쇄 API)
  - 마크다운 다중 형식 (일별/주별/월별)
  - JSON 구조 개선 (메타데이터 포함)
- **UI**: 
  - 설정 페이지에 형식 선택 드롭다운
  - 날짜 범위 선택
  - 다운로드 버튼
- **예상 작업 시간**: 1주
- **철학 부합도**: ⭐⭐⭐ (외부 도구와의 연결)

---

## 6. 구현 권장 순서

1. **검색 기능** (1주)
   - 가장 즉각적인 가치 제공
   - 사용자가 과거 반성을 쉽게 찾아 연결점 발견
   - 구현 난이도: 낮음

2. **패턴 인식** (1.5주)
   - 검색 기능 이후 자연스러운 확장
   - 주간 인사이트 페이지와 통합 용이
   - 구현 난이도: 중간

3. **익스포트 개선** (1주)
   - 필요 시점에 추가
   - 사용자 요청에 따라 우선순위 조정 가능
   - 구현 난이도: 낮음

---

## 7. 제외된 기능 (철학에 맞지 않음)

- ❌ 사용자 계정/인증: 로컬 퍼스트 철학과 충돌
- ❌ 소셜 기능: 개인 성찰 도구의 본질 훼손
- ❌ 과도한 시각화: 차트/그래프는 조용한 사고를 방해
- ❌ AI 채팅: 일방향 분석이 더 효과적
- ❌ 알림/리마인더: 사용자가 필요할 때만 사용하는 도구

